# Logging 模块高并发测试

本目录包含 XiHan.Framework.Utils.Logging 模块的高并发和性能测试用例。

## 测试文件说明

### 1. LogFileHelperConcurrencyTests.cs

**文件日志助手并发测试**

**测试场景:**

- ✅ **线程安全写入测试**: 50 个线程同时写入 100 条消息，验证无数据丢失
- ✅ **缓冲区压力测试**: 小缓冲区(10 条)下 1000 条消息快速写入
- ✅ **文件滚动测试**: 1KB 文件大小限制下强制文件滚动
- ✅ **混合日志级别测试**: 并发写入不同级别日志(Info/Warn/Error/Success/Handle)
- ✅ **异步写入性能测试**: 5000 条消息异步写入性能验证
- ✅ **长时间运行稳定性测试**: 10 分钟连续写入稳定性检查
- ✅ **内存压力测试**: 大数据量(1KB 消息)并发写入内存控制

### 2. LogHelperConcurrencyTests.cs

**控制台日志助手并发测试**

**测试场景:**

- ✅ **控制台输出线程安全**: 20 个线程并发控制台输出
- ✅ **格式化消息并发处理**: 1000 条格式化消息并发处理
- ✅ **彩虹模式并发稳定性**: 10 个线程并发彩虹输出
- ✅ **表格输出线程安全**: 50 个表格并发输出
- ✅ **日志级别过滤并发**: 并发日志级别过滤功能验证
- ✅ **异常处理并发安全**: 100 个任务并发异常处理测试
- ✅ **设置更改线程安全**: 并发修改日志设置的安全性
- ✅ **控制台清除并发稳定**: 50 次并发控制台清除操作
- ✅ **高容量输出稳定性**: 25 个线程 ×200 条消息压力测试

### 3. LoggingPerformanceTests.cs

**性能基准测试**

**基准测试:**

- ✅ **单线程写入性能**: 10,000 条消息单线程写入基准
- ✅ **多线程写入性能**: CPU 核心数 ×2000 条消息并发基准
- ✅ **缓冲区效率对比**: 不同缓冲区大小(1,10,50,100,500)性能对比
- ✅ **异步 vs 同步性能**: 8000 条消息异步/同步写入性能对比
- ✅ **大数据量压力测试**: 50,000 条 ×500 字符消息压力测试
- ✅ **长期耐久性测试**: 2 分钟连续写入稳定性测试
- ✅ **资源清理测试**: 内存泄漏和资源释放验证

### 4. LoggingStressTests.cs

**极限压力测试**

**压力测试:**

- ✅ **极限并发测试**: CPU 核心数 ×4 线程极限并发
- ✅ **内存压力测试**: 100MB 内存限制下大数据写入
- ✅ **文件系统压力**: 50KB 文件频繁滚动压力测试
- ✅ **错误恢复测试**: 文件系统错误模拟和恢复能力
- ✅ **资源竞争测试**: 多种操作(写入/刷新/配置)同时进行
- ✅ **长期稳定性**: 10 轮 ×1000 条消息内存泄漏检查

## 性能指标

### 预期性能指标

- **单线程吞吐量**: > 1,000 消息/秒
- **多线程吞吐量**: > 2,000 消息/秒
- **平均延迟**: < 1,000 微秒/消息
- **内存使用**: 稳定，无明显泄漏
- **错误率**: < 1%

### 并发能力

- **最大并发线程**: CPU 核心数 × 4
- **缓冲区容量**: 50-500 条消息
- **文件滚动**: 自动，基于大小限制
- **异步写入**: 支持，性能优于同步

## 运行测试

```bash
# 运行所有日志测试
dotnet test --filter "FullyQualifiedName~Logging"

# 运行特定测试类
dotnet test --filter "LogFileHelperConcurrencyTests"
dotnet test --filter "LogHelperConcurrencyTests"
dotnet test --filter "LoggingPerformanceTests"
dotnet test --filter "LoggingStressTests"

# 运行性能测试（详细输出）
dotnet test --filter "LoggingPerformanceTests" --logger "console;verbosity=detailed"
```

## 测试环境要求

- **.NET 9.0** 或更高版本
- **xUnit** 测试框架
- **足够磁盘空间** (测试会创建大量临时日志文件)
- **多核 CPU** (并发测试效果更佳)

## 注意事项

1. **临时文件清理**: 所有测试都会自动清理临时文件
2. **跨平台兼容**: 测试设计为跨平台兼容(Windows/Linux/macOS)
3. **性能环境差异**: 性能基准可能因硬件环境而异
4. **资源限制**: 在资源受限环境中某些压力测试可能需要调整参数

## 贡献指南

添加新的并发测试时请遵循以下原则:

1. **独立性**: 每个测试方法应该独立运行
2. **清理**: 必须正确清理所有临时资源
3. **超时**: 为长时间运行的测试设置合理超时
4. **断言**: 包含有意义的性能和正确性断言
5. **文档**: 为复杂测试场景添加详细注释

---

> 这些测试确保 XiHan.Framework.Utils.Logging 模块在高并发环境下的可靠性和性能表现。
