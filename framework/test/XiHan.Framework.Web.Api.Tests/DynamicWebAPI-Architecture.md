# åŠ¨æ€ WebAPI æ¶æ„è®¾è®¡

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

åŠ¨æ€ WebAPI åŠŸèƒ½æ˜¯ XiHan.Framework çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œå®ƒé‡‡ç”¨çº¦å®šä¼˜äºé…ç½®çš„è®¾è®¡ç†å¿µï¼Œé€šè¿‡è‡ªåŠ¨å‘ç°å’Œæ˜ å°„åº”ç”¨æœåŠ¡åˆ° REST APIï¼Œæå¤§åœ°ç®€åŒ–äº† Web API çš„å¼€å‘æµç¨‹ã€‚

## ğŸ“ æ¶æ„å±‚æ¬¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è¡¨ç°å±‚ (Presentation Layer)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         åŠ¨æ€ç”Ÿæˆçš„ REST API æ§åˆ¶å™¨                    â”‚   â”‚
â”‚  â”‚  (DynamicApiController - è¿è¡Œæ—¶ç”Ÿæˆ)                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   åº”ç”¨å±‚ (Application Layer)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  åº”ç”¨æœåŠ¡æ¥å£         â”‚  â”‚  CRUD åº”ç”¨æœåŠ¡        â”‚        â”‚
â”‚  â”‚  IApplicationService â”‚  â”‚  ICrudAppService     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  åº”ç”¨æœåŠ¡åŸºç±»         â”‚  â”‚  æ‰¹é‡æ“ä½œæœåŠ¡         â”‚        â”‚
â”‚  â”‚  ApplicationBase     â”‚  â”‚  IBatchCrudAppServiceâ”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              åŠ¨æ€ API åŸºç¡€è®¾æ–½ (Infrastructure)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  çº¦å®šè§„åˆ™å¼•æ“         â”‚  â”‚  æ§åˆ¶å™¨ç”Ÿæˆå™¨         â”‚        â”‚
â”‚  â”‚  Convention Engine   â”‚  â”‚  Controller Factory  â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  è·¯ç”±é…ç½®å™¨           â”‚  â”‚  å‚æ•°ç»‘å®šå™¨           â”‚        â”‚
â”‚  â”‚  Route Configurator  â”‚  â”‚  Parameter Binder    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  ç‰ˆæœ¬æ§åˆ¶ç®¡ç†å™¨       â”‚  â”‚  æ‰¹é‡æ“ä½œå¤„ç†å™¨       â”‚        â”‚
â”‚  â”‚  Version Manager     â”‚  â”‚  Batch Handler       â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    é¢†åŸŸå±‚ (Domain Layer)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  å®ä½“ (Entities)      â”‚  â”‚  èšåˆæ ¹ (Aggregates) â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  ä»“å‚¨æ¥å£ (IRepository)â”‚ â”‚  è§„çº¦ (Specifications)â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ æ ¸å¿ƒç»„ä»¶

### 1. åº”ç”¨æœåŠ¡å±‚

#### 1.1 IApplicationService

```csharp
/// <summary>
/// åº”ç”¨æœåŠ¡æ ‡è®°æ¥å£
/// å®ç°æ­¤æ¥å£çš„æœåŠ¡å°†è‡ªåŠ¨æš´éœ²ä¸º REST API
/// </summary>
public interface IApplicationService : IRemoteService
{
}
```

**è®¾è®¡è€ƒè™‘ï¼š**

- ç»§æ‰¿è‡ª `IRemoteService`ï¼Œæ ‡è®°å¯è¿œç¨‹è®¿é—®çš„æœåŠ¡
- ä½œä¸ºæ ‡è®°æ¥å£ï¼Œç”¨äºæœåŠ¡å‘ç°
- æ”¯æŒä¾èµ–æ³¨å…¥å’Œç”Ÿå‘½å‘¨æœŸç®¡ç†

#### 1.2 ICrudApplicationService

```csharp
/// <summary>
/// CRUD åº”ç”¨æœåŠ¡æ¥å£
/// æä¾›æ ‡å‡†çš„å¢åˆ æ”¹æŸ¥æ“ä½œ
/// </summary>
public interface ICrudApplicationService<TEntityDto, TKey>
{
    Task<TEntityDto?> GetAsync(TKey id);
    Task<PageResponseDto<TEntityDto>> GetListAsync(PageQuery input);
    Task<TEntityDto> CreateAsync(TEntityDto input);
    Task<TEntityDto> UpdateAsync(TKey id, TEntityDto input);
    Task<bool> DeleteAsync(TKey id);
}
```

**è®¾è®¡è€ƒè™‘ï¼š**

- éµå¾ª RESTful è®¾è®¡åŸåˆ™
- æ”¯æŒåˆ†é¡µæŸ¥è¯¢
- æ³›å‹è®¾è®¡ï¼Œé€‚ç”¨äºå„ç§å®ä½“ç±»å‹
- å¼‚æ­¥æ“ä½œï¼Œæå‡æ€§èƒ½

#### 1.3 ApplicationServiceBase

```csharp
/// <summary>
/// åº”ç”¨æœåŠ¡åŸºç±»
/// æä¾›é€šç”¨åŠŸèƒ½å’Œä¾èµ–æ³¨å…¥
/// </summary>
public abstract class ApplicationServiceBase : IApplicationService
{
    public ICachedServiceProvider ServiceProvider { get; set; }
    protected ILogger Logger => LazyLogger.Value;
}
```

**è®¾è®¡è€ƒè™‘ï¼š**

- æä¾›æœåŠ¡æä¾›è€…è®¿é—®
- å»¶è¿ŸåŠ è½½æ—¥å¿—è®°å½•å™¨
- æ”¯æŒå±æ€§æ³¨å…¥

### 2. åŠ¨æ€ API çº¦å®šå¼•æ“

#### 2.1 IDynamicApiConvention

```csharp
/// <summary>
/// åŠ¨æ€ API çº¦å®šæ¥å£
/// å®šä¹‰è·¯ç”±ç”Ÿæˆã€HTTP æ–¹æ³•æ˜ å°„ç­‰è§„åˆ™
/// </summary>
public interface IDynamicApiConvention
{
    void Apply(DynamicApiConventionContext context);
}
```

**è®¾è®¡è€ƒè™‘ï¼š**

- å¯æ‰©å±•çš„çº¦å®šç³»ç»Ÿ
- æ”¯æŒè‡ªå®šä¹‰è§„åˆ™
- é“¾å¼å¤„ç†æœºåˆ¶

#### 2.2 DefaultDynamicApiConvention

```csharp
/// <summary>
/// é»˜è®¤çº¦å®šå®ç°
/// æä¾›å¼€ç®±å³ç”¨çš„çº¦å®šè§„åˆ™
/// </summary>
public class DefaultDynamicApiConvention : IDynamicApiConvention
{
    // è·¯ç”±ç”Ÿæˆè§„åˆ™
    // HTTP æ–¹æ³•æ¨æ–­è§„åˆ™
    // å‚æ•°ç»‘å®šè§„åˆ™
    // å‘½åè½¬æ¢è§„åˆ™
}
```

**çº¦å®šè§„åˆ™ï¼š**

| æ–¹æ³•å‰ç¼€ | HTTP æ–¹æ³• | è·¯ç”±æ¨¡æ¿        | è¯´æ˜     |
| -------- | --------- | --------------- | -------- |
| Get      | GET       | /resource/{id?} | æŸ¥è¯¢æ“ä½œ |
| Create   | POST      | /resource       | åˆ›å»ºæ“ä½œ |
| Update   | PUT       | /resource/{id}  | æ›´æ–°æ“ä½œ |
| Delete   | DELETE    | /resource/{id}  | åˆ é™¤æ“ä½œ |
| Patch    | PATCH     | /resource/{id}  | éƒ¨åˆ†æ›´æ–° |

### 3. æ§åˆ¶å™¨ç”Ÿæˆå™¨

#### 3.1 DynamicApiControllerFactory

```csharp
/// <summary>
/// åŠ¨æ€æ§åˆ¶å™¨å·¥å‚
/// ä½¿ç”¨åå°„å‘å‡º (Reflection.Emit) åœ¨è¿è¡Œæ—¶ç”Ÿæˆæ§åˆ¶å™¨
/// </summary>
public static class DynamicApiControllerFactory
{
    public static Type? CreateControllerType(Type serviceType)
    {
        // 1. åˆ›å»º TypeBuilder
        // 2. æ·»åŠ  ApiController å’Œ Route ç‰¹æ€§
        // 3. åˆ›å»ºæ„é€ å‡½æ•°ï¼Œæ³¨å…¥åº”ç”¨æœåŠ¡
        // 4. ä¸ºæ¯ä¸ªæœåŠ¡æ–¹æ³•åˆ›å»ºå¯¹åº”çš„åŠ¨ä½œæ–¹æ³•
        // 5. è¿”å›ç”Ÿæˆçš„æ§åˆ¶å™¨ç±»å‹
    }
}
```

**æŠ€æœ¯å®ç°ï¼š**

- ä½¿ç”¨ `System.Reflection.Emit` åŠ¨æ€ç”Ÿæˆ IL ä»£ç 
- åˆ›å»ºç»§æ‰¿è‡ª `ControllerBase` çš„æ§åˆ¶å™¨ç±»
- è‡ªåŠ¨æ·»åŠ å¿…è¦çš„ç‰¹æ€§å’Œè·¯ç”±
- ä»£ç†è°ƒç”¨åº”ç”¨æœåŠ¡æ–¹æ³•

#### 3.2 DynamicApiControllerFeatureProvider

```csharp
/// <summary>
/// æ§åˆ¶å™¨ç‰¹æ€§æä¾›è€…
/// é›†æˆåˆ° ASP.NET Core çš„åº”ç”¨ç¨‹åºéƒ¨ä»¶ç³»ç»Ÿ
/// </summary>
public class DynamicApiControllerFeatureProvider : IApplicationFeatureProvider<ControllerFeature>
{
    public void PopulateFeature(IEnumerable<ApplicationPart> parts, ControllerFeature feature)
    {
        // 1. æ‰«ææ‰€æœ‰åº”ç”¨æœåŠ¡
        // 2. ä¸ºæ¯ä¸ªæœåŠ¡ç”Ÿæˆæ§åˆ¶å™¨
        // 3. æ·»åŠ åˆ°æ§åˆ¶å™¨ç‰¹æ€§é›†åˆ
    }
}
```

### 4. æ‰¹é‡æ“ä½œæ”¯æŒ

#### 4.1 æ‰¹é‡æ“ä½œè¯·æ±‚æ¨¡å‹

```csharp
/// <summary>
/// æ‰¹é‡æ“ä½œè¯·æ±‚
/// </summary>
public class BatchOperationRequest<T>
{
    public List<T> Items { get; set; }
    public bool ContinueOnError { get; set; }
    public bool UseTransaction { get; set; }
}
```

**è®¾è®¡ç‰¹ç‚¹ï¼š**

- æ”¯æŒäº‹åŠ¡æ§åˆ¶
- æ”¯æŒé”™è¯¯å¤„ç†ç­–ç•¥
- ç»Ÿä¸€çš„è¯·æ±‚æ ¼å¼

#### 4.2 æ‰¹é‡æ“ä½œå“åº”æ¨¡å‹

```csharp
/// <summary>
/// æ‰¹é‡æ“ä½œå“åº”
/// </summary>
public class BatchOperationResponse<T>
{
    public int SuccessCount { get; set; }
    public int FailureCount { get; set; }
    public List<BatchOperationResult<T>> Results { get; set; }
    public List<string> Errors { get; set; }
}
```

**è®¾è®¡ç‰¹ç‚¹ï¼š**

- è¯¦ç»†çš„æ‰§è¡Œç»“æœ
- æ”¯æŒéƒ¨åˆ†æˆåŠŸåœºæ™¯
- é”™è¯¯ä¿¡æ¯æ”¶é›†

### 5. API ç‰ˆæœ¬æ§åˆ¶

#### 5.1 ç‰ˆæœ¬ç‰¹æ€§

```csharp
[ApiVersion("1.0")]
public class UserV1AppService { }

[ApiVersion("2.0")]
public class UserV2AppService { }
```

**ç‰ˆæœ¬ç­–ç•¥ï¼š**

- URL è·¯å¾„ç‰ˆæœ¬åŒ–: `/api/v1/users`
- æŸ¥è¯¢å­—ç¬¦ä¸²ç‰ˆæœ¬åŒ–: `/api/users?api-version=1.0`
- è¯·æ±‚å¤´ç‰ˆæœ¬åŒ–: `X-API-Version: 1.0`
- æ”¯æŒç‰ˆæœ¬å¼ƒç”¨æ ‡è®°

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. åº”ç”¨å¯åŠ¨é˜¶æ®µ

```mermaid
sequenceDiagram
    participant App as åº”ç”¨ç¨‹åº
    participant Module as DynamicApiModule
    participant Provider as FeatureProvider
    participant Factory as ControllerFactory

    App->>Module: ConfigureServices
    Module->>App: æ³¨å†ŒåŠ¨æ€ API æœåŠ¡
    App->>Provider: æ‰«æåº”ç”¨æœåŠ¡
    Provider->>Factory: ç”Ÿæˆæ§åˆ¶å™¨
    Factory->>Provider: è¿”å›æ§åˆ¶å™¨ç±»å‹
    Provider->>App: æ³¨å†Œæ§åˆ¶å™¨
```

### 2. è¯·æ±‚å¤„ç†é˜¶æ®µ

```mermaid
sequenceDiagram
    participant Client as å®¢æˆ·ç«¯
    participant Controller as åŠ¨æ€æ§åˆ¶å™¨
    participant Service as åº”ç”¨æœåŠ¡
    participant Repo as ä»“å‚¨

    Client->>Controller: HTTP è¯·æ±‚
    Controller->>Controller: å‚æ•°ç»‘å®š
    Controller->>Controller: æ¨¡å‹éªŒè¯
    Controller->>Service: è°ƒç”¨æœåŠ¡æ–¹æ³•
    Service->>Repo: æ•°æ®æ“ä½œ
    Repo->>Service: è¿”å›ç»“æœ
    Service->>Controller: è¿”å› DTO
    Controller->>Client: HTTP å“åº”
```

### 3. çº¦å®šåº”ç”¨æµç¨‹

```mermaid
flowchart TD
    A[åº”ç”¨æœåŠ¡] --> B{æ˜¯å¦ç¦ç”¨?}
    B -->|æ˜¯| C[è·³è¿‡]
    B -->|å¦| D[ç”Ÿæˆæ§åˆ¶å™¨åç§°]
    D --> E[éå†æ–¹æ³•]
    E --> F{æ˜¯å¦ç¦ç”¨?}
    F -->|æ˜¯| G[è·³è¿‡æ–¹æ³•]
    F -->|å¦| H[ç”ŸæˆåŠ¨ä½œåç§°]
    H --> I[æ¨æ–­ HTTP æ–¹æ³•]
    I --> J[ç”Ÿæˆè·¯ç”±æ¨¡æ¿]
    J --> K[åº”ç”¨ç‰ˆæœ¬æ§åˆ¶]
    K --> L[æ³¨å†Œ API]
```

## ğŸ“Š è®¾è®¡æ¨¡å¼

### 1. å·¥å‚æ¨¡å¼ (Factory Pattern)

- **DynamicApiControllerFactory**: åŠ¨æ€åˆ›å»ºæ§åˆ¶å™¨å®ä¾‹
- **ä¼˜åŠ¿**: å°è£…å¤æ‚çš„åˆ›å»ºé€»è¾‘ï¼Œæ”¯æŒè¿è¡Œæ—¶ç±»å‹ç”Ÿæˆ

### 2. çº¦å®šä¼˜äºé…ç½® (Convention over Configuration)

- **é»˜è®¤çº¦å®š**: è‡ªåŠ¨æ¨æ–­è·¯ç”±ã€HTTP æ–¹æ³•
- **ä¼˜åŠ¿**: å‡å°‘é…ç½®å·¥ä½œï¼Œæå‡å¼€å‘æ•ˆç‡

### 3. ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

- **IDynamicApiConvention**: å¯æ›¿æ¢çš„çº¦å®šç­–ç•¥
- **ä¼˜åŠ¿**: çµæ´»çš„è§„åˆ™å®šåˆ¶ï¼Œæ˜“äºæ‰©å±•

### 4. æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)

- **ApplicationServiceBase**: å®šä¹‰æœåŠ¡æ‰§è¡Œæµç¨‹
- **ä¼˜åŠ¿**: ç»Ÿä¸€çš„å¤„ç†é€»è¾‘ï¼Œå­ç±»åªéœ€å®ç°ç‰¹å®šæ­¥éª¤

### 5. è£…é¥°å™¨æ¨¡å¼ (Decorator Pattern)

- **ç‰¹æ€§æ ‡æ³¨**: é€šè¿‡ç‰¹æ€§å¢å¼ºåŠŸèƒ½
- **ä¼˜åŠ¿**: çµæ´»çš„åŠŸèƒ½ç»„åˆï¼Œä¸å½±å“æ ¸å¿ƒé€»è¾‘

### 6. å»ºé€ è€…æ¨¡å¼ (Builder Pattern)

- **DynamicApiOptions**: æµå¼é…ç½® API
- **ä¼˜åŠ¿**: æ¸…æ™°çš„é…ç½®æ¥å£ï¼Œæ˜“äºç†è§£

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™ (SRP)

- æ¯ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½é¢†åŸŸ
- åº”ç”¨æœåŠ¡åªè´Ÿè´£ä¸šåŠ¡é€»è¾‘
- æ§åˆ¶å™¨åªè´Ÿè´£è¯·æ±‚å“åº”

### 2. å¼€é—­åŸåˆ™ (OCP)

- å¯¹æ‰©å±•å¼€æ”¾ï¼šæ”¯æŒè‡ªå®šä¹‰çº¦å®šã€è‡ªå®šä¹‰æ§åˆ¶å™¨
- å¯¹ä¿®æ”¹å…³é—­ï¼šæ ¸å¿ƒé€»è¾‘ç¨³å®šï¼Œé€šè¿‡æ‰©å±•ç‚¹æ·»åŠ åŠŸèƒ½

### 3. é‡Œæ°æ›¿æ¢åŸåˆ™ (LSP)

- åŸºç±»å¯ä»¥è¢«å­ç±»æ›¿æ¢
- æ‰€æœ‰åº”ç”¨æœåŠ¡åŸºç±»éƒ½å¯äº’æ¢ä½¿ç”¨

### 4. æ¥å£éš”ç¦»åŸåˆ™ (ISP)

- æä¾›ç»†ç²’åº¦çš„æ¥å£
- `ICrudApplicationService` vs `IBatchCrudApplicationService`

### 5. ä¾èµ–å€’ç½®åŸåˆ™ (DIP)

- ä¾èµ–æŠ½è±¡è€Œéå…·ä½“å®ç°
- é€šè¿‡æ¥å£å®šä¹‰å¥‘çº¦

## ğŸ” å®‰å…¨è€ƒè™‘

### 1. è¾“å…¥éªŒè¯

```csharp
public class CreateUserDto
{
    [Required]
    [StringLength(50)]
    public string UserName { get; set; }

    [EmailAddress]
    public string Email { get; set; }
}
```

### 2. è®¤è¯æˆæƒ

```csharp
[DynamicApi]
[Authorize]
public class UserAppService
{
    [Authorize(Roles = "Admin")]
    public Task<bool> DeleteAsync(long id) { }
}
```

### 3. é™æµä¿æŠ¤

```csharp
[RateLimit(PermitLimit = 100, Window = 60)]
public class UserAppService { }
```

### 4. CORS é…ç½®

```csharp
services.AddCors(options =>
{
    options.AddPolicy("AllowSpecificOrigin",
        builder => builder.WithOrigins("https://example.com"));
});
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. æ§åˆ¶å™¨ç¼“å­˜

- ç”Ÿæˆçš„æ§åˆ¶å™¨ç±»å‹ç¼“å­˜åœ¨å†…å­˜ä¸­
- é¿å…é‡å¤ç”Ÿæˆ IL ä»£ç 

### 2. å¼‚æ­¥æ“ä½œ

- æ‰€æœ‰æ•°æ®è®¿é—®éƒ½ä½¿ç”¨å¼‚æ­¥æ–¹æ³•
- æå‡å¹¶å‘å¤„ç†èƒ½åŠ›

### 3. åˆ†é¡µæŸ¥è¯¢

- é¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®
- æ”¯æŒæµå¼å¤„ç†

### 4. æ‰¹é‡æ“ä½œä¼˜åŒ–

- ä½¿ç”¨äº‹åŠ¡å‡å°‘æ•°æ®åº“å¾€è¿”
- æ”¯æŒå¹¶è¡Œå¤„ç†

## ğŸ§ª å¯æµ‹è¯•æ€§

### 1. å•å…ƒæµ‹è¯•

```csharp
[Fact]
public async Task GetAsync_ExistingId_ReturnsDto()
{
    // Arrange
    var mockRepo = new Mock<IRepositoryBase<User, long>>();
    var service = new UserAppService(mockRepo.Object);

    // Act
    var result = await service.GetAsync(1);

    // Assert
    Assert.NotNull(result);
}
```

### 2. é›†æˆæµ‹è¯•

```csharp
[Fact]
public async Task GetUsers_ReturnsOkResult()
{
    // Arrange
    var client = _factory.CreateClient();

    // Act
    var response = await client.GetAsync("/api/users");

    // Assert
    response.EnsureSuccessStatusCode();
}
```

## ğŸ“š æ‰©å±•ç‚¹

### 1. è‡ªå®šä¹‰çº¦å®š

å®ç° `IDynamicApiConvention` æ¥å£

### 2. è‡ªå®šä¹‰æ§åˆ¶å™¨

ç»§æ‰¿ `XiHanController` æˆ– `ControllerBase`

### 3. è‡ªå®šä¹‰ç‰¹æ€§

åˆ›å»ºç»§æ‰¿è‡ª `Attribute` çš„è‡ªå®šä¹‰ç‰¹æ€§

### 4. è‡ªå®šä¹‰ä¸­é—´ä»¶

å®ç° ASP.NET Core ä¸­é—´ä»¶

## ğŸŒŸ æœ€ä½³å®è·µæ€»ç»“

1. âœ… **ä½¿ç”¨å¼ºç±»å‹ DTO**ï¼šé¿å…ç›´æ¥æš´éœ²å®ä½“
2. âœ… **åˆ†ç¦»è¯»å†™æ“ä½œ**ï¼šCQRS æ¨¡å¼
3. âœ… **ç»Ÿä¸€é”™è¯¯å¤„ç†**ï¼šå…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
4. âœ… **å®Œå–„çš„æ—¥å¿—è®°å½•**ï¼šä¾¿äºé—®é¢˜æ’æŸ¥
5. âœ… **API ç‰ˆæœ¬ç®¡ç†**ï¼šå¹³æ»‘å‡çº§
6. âœ… **å®Œæ•´çš„æ–‡æ¡£**ï¼šSwagger/OpenAPI
7. âœ… **æ€§èƒ½ç›‘æ§**ï¼šAPM å·¥å…·é›†æˆ
8. âœ… **å®‰å…¨é˜²æŠ¤**ï¼šè®¤è¯ã€æˆæƒã€é™æµ

## ğŸ”® æœªæ¥å±•æœ›

1. ğŸš€ **GraphQL æ”¯æŒ**ï¼šåŠ¨æ€ç”Ÿæˆ GraphQL Schema
2. ğŸš€ **gRPC æ”¯æŒ**ï¼šè‡ªåŠ¨ç”Ÿæˆ gRPC æœåŠ¡
3. ğŸš€ **WebSocket æ”¯æŒ**ï¼šå®æ—¶é€šä¿¡èƒ½åŠ›
4. ğŸš€ **ä»£ç ç”Ÿæˆå·¥å…·**ï¼šCLI å·¥å…·
5. ğŸš€ **æ€§èƒ½åˆ†æ**ï¼šå†…ç½®æ€§èƒ½ç›‘æ§
6. ğŸš€ **è‡ªåŠ¨åŒ–æµ‹è¯•**ï¼šæµ‹è¯•ç”¨ä¾‹ç”Ÿæˆ

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [åŠ¨æ€ WebAPI ä½¿ç”¨æ–‡æ¡£](./DynamicWebAPI.md)
- [åŠ¨æ€ WebAPI ç¤ºä¾‹](./DynamicWebAPI-Examples.md)
- [åº”ç”¨æœåŠ¡å¼€å‘æŒ‡å—](./ApplicationServices.md)
- [æ¡†æ¶æ¶æ„è¯´æ˜](./1.Architecture.md)
